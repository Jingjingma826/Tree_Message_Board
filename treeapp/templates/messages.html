{% extends 'layout.html' %}

{% block title %}Messages Board{% endblock %}

{% block content %}
<h1>Tree Talk Messages Board</h1>
{% if msg %}
    <div id="alert-message" data-message="{{ msg }}" style="display: none;"></div>
{% endif %}
<div class="new-message-container">
    <section class="new-message">
        <h2>Post a New Message</h2>
        <form action="{{ url_for('messages') }}" method="post">
            <div class="form-group">
                <textarea id="message-content" name="message_content" class="form-control" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Post Message</button>
        </form>
    </section>
</div>

<main>
    <section class="message-list">
        {% for message in messages %}
            <div class="card message-card">
                <div class="card-header">
                    <h2>{{ message.title }}</h2>
                </div>
                <div class="card-body">
                    <p><strong>Username:</strong> {{ message.username }}</p>
                    <p><strong>Message:</strong> {{ message.content }}</p>
                    <p><strong>Posted on:</strong> {{ message.created_at }}</p>
                    
                    <!-- Display reply button and delete button for the message -->
                    <div class="reply-buttons">
                        <button class="btn btn-primary" onclick="toggleReplies('{{ message.message_id }}')">Show Replies</button>
                        <button class="btn btn-secondary" onclick="toggleReplyForm('message-{{ message.message_id }}')">Reply</button>
                        {% if message.user_id == session['id'] or session['role'] in ['admin', 'moderator'] %}
                            <form action="{{ url_for('delete_message', message_id=message.message_id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this message and all its replies?');" style="display:inline;">
                                <input type="submit" value="Delete Message" class="btn btn-danger">
                            </form>
                        {% endif %}
                    </div>
                    
                    <div class="replies" id="replies-{{ message.message_id }}" style="display: none;">
                        {% for reply in replies if reply.message_id == message.message_id %}
                            <div class="card reply-card">
                                <div class="card-body">
                                    <p><strong>Username:</strong> {{ reply.username }}</p>
                                    <p><strong>Reply:</strong> {{ reply.content }}</p>
                                    <p><strong>Posted on:</strong> {{ reply.created_at }}</p>
                                    
                                    <!-- Display reply button and delete button for the reply -->
                                    <div class="reply-buttons">
                                        {% if reply.user_id == session['id'] or session['role'] in ['admin', 'moderator'] %}
                                            <form action="{{ url_for('delete_reply', reply_id=reply.reply_id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this reply?');" style="display:inline;">
                                                <input type="submit" value="Delete Reply" class="btn btn-danger">
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Reply form for this message -->
                    <div class="reply-form" id="reply-form-message-{{ message.message_id }}" style="display: none;">
                        <form action="{{ url_for('messages') }}" method="post">
                            <input type="hidden" name="message_id" value="{{ message.message_id }}">
                            <div class="form-group" style="text-align: left; margin: 0 auto; width: 80%;">
                                <label for="reply-content-message-{{ message.message_id }}">Reply Content:</label>
                                <textarea id="reply-content-message-{{ message.message_id }}" name="reply_content" class="form-control" style="width: 100%; height: 100px;" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Post Reply</button>
                        </form>
                    </div>

                </div>
            </div>
        {% endfor %}
    </section>
</main>

<script src="{{ url_for('static', filename='scripts.js') }}"></script>

{% endblock %}
